<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>design</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

    <style>
        .mermaid {
            text-align: center;
            margin: 2em 0;
        }
    </style>
    </head>
    
<body>
<h1 id="system-design-test-orchestration-platform-topas">System Design:
Test Orchestration Platform (TOPAS)</h1>
<p>This document outlines the architecture for a platform that
orchestrates granular system tests using Kubernetes and Lua
scripting.</p>
<h2 id="core-concept">1. Core Concept</h2>
<p>The platform consists of two main components: 1. <strong>System
Controller (SUT)</strong>: Manages the lifecycle of the application
under test (the “App”). 2. <strong>Test Framework</strong>: A Lua-based
scripting environment invoked via CLI to execute complex test scenarios
(upgrades, state verification, etc.).</p>
<h3 id="architecture-diagram">Architecture Diagram</h3>
<div class="mermaid">graph TB
    CLI["kctrl CLI"]
    LuaFile["test.lua"]
    PmFile["collection.json"]

    subgraph ControlPlane["Control Plane"]
        API["K8s API Server"]
        SC["SUT Controller"]
        TC["TestRun Controller"]
    end

    subgraph DataPlane["Data Plane - Runner Pod"]
        CM["ConfigMap: test.lua"]
        InitGit["Init: git clone"]
        LuaVM["Lua VM"]
        SutMod["sut module"]
        HttpMod["http module"]
        DbMod["db module"]
        GrpcMod["grpc module"]
        PmMod["postman module"]
        Newman["newman CLI"]
    end

    subgraph SUT["System Under Test"]
        Dep["Deployments"]
        Svc["Services"]
        DB["Database"]
        InitJob["Init Job: psql"]
    end

    CLI -->|create TestRun CR| API
    CLI -->|stream logs| DataPlane
    LuaFile -->|bundled| DataPlane
    PmFile -->|bundled| DataPlane

    API -->|watch App| SC
    API -->|watch TestRun| TC
    TC -->|create Pod| DataPlane
    SC -->|reconcile| Dep
    SC -->|reconcile| Svc
    SC -->|deploy| DB
    SC -->|create| InitJob
    InitJob -->|run DDL| DB

    CM --> LuaVM
    InitGit --> LuaVM

    LuaVM --> SutMod
    LuaVM --> HttpMod
    LuaVM --> DbMod
    LuaVM --> GrpcMod
    LuaVM --> PmMod

    SutMod -->|K8s API| API
    HttpMod -->|HTTP| Svc
    DbMod -->|SQL| DB
    PmMod -->|subprocess| Newman
    Newman -->|HTTP| Svc

    classDef user fill:#f3e5f5,stroke:#7b1fa2,color:#000
    classDef control fill:#e1f5fe,stroke:#01579b,color:#000
    classDef data fill:#fff3e0,stroke:#e65100,color:#000
    classDef sut fill:#e8f5e9,stroke:#2e7d32,color:#000
    classDef module fill:#fce4ec,stroke:#c62828,color:#000

    class CLI,LuaFile,PmFile user
    class API,SC,TC control
    class CM,InitGit,LuaVM,Newman data
    class SutMod,HttpMod,DbMod,GrpcMod,PmMod module
    class Dep,Svc,DB,InitJob sut</div>
<hr />
<h2 id="system-under-test-sut-controller">2. System Under Test (SUT)
Controller</h2>
<p>The <code>App</code> CRD acts as the “Inventory” and “Control Plane”
for the system being tested.</p>
<h3 id="app-crd"><code>App</code> CRD</h3>
<ul>
<li><p><strong>Purpose</strong>: Defines the stack of composed services
and databases.</p></li>
<li><p><strong>Schema</strong>:
``<code>go   type ServiceSpec struct {       Name     string</code>json:“name”<code>Image    string</code>json:“image”<code>Version  string</code>json:“version”<code>Replicas *int32</code>json:“replicas,omitempty”<code>Port     int32</code>json:“port”<code>EnvVars  map[string]string</code>json:“envVars,omitempty”`
}</p>
<p>type DatabaseSpec struct { Name string <code>json:"name"</code> Image
string <code>json:"image"</code> // e.g. postgres:16-alpine Port int32
<code>json:"port"</code> Credentials map[string]string
<code>json:"credentials"</code> // user, password, dbname InitSQL string
<code>json:"initSQL,omitempty"</code> }</p>
<p>type AppSpec struct { Services []ServiceSpec
<code>json:"services"</code> Databases []DatabaseSpec
<code>json:"databases,omitempty"</code> } ```</p></li>
<li><p><strong>Controller Logic</strong>:</p>
<ul>
<li>Reconciles <code>Services[]</code> → Kubernetes
<code>Deployment</code> + <code>Service</code> pairs.</li>
<li>Reconciles <code>Databases[]</code> → <code>Deployment</code> +
<code>Service</code> + one-time <strong>init Job</strong> (runs
<code>psql</code> with <code>InitSQL</code>).</li>
<li>Injects env vars (e.g. <code>POSTGRES_USER/PASSWORD/DB</code>) into
database containers.</li>
<li>Injects <code>EnvVars</code> (e.g. <code>DATABASE_URL</code>) into
service containers.</li>
<li><strong>Self-Healing</strong>: Ensures the deployed version always
matches the spec.</li>
<li><strong>Scope</strong>: Manages schema (DDL) but not database
software versioning (e.g. Postgres 15→16).</li>
</ul></li>
</ul>
<h3 id="reconciliation-logic">Reconciliation Logic</h3>
<div class="mermaid">flowchart TD
    Start([Reconcile Loop]) --> FetchCR{Fetch App CR}
    FetchCR -- Not Found --> Stop([Stop])
    FetchCR -- Found --> DBs[Reconcile Databases]
    
    subgraph DB_Reconcile [Database Reconciliation]
        DBs --> DB_Dep[Ensure Deployment]
        DB_Dep --> DB_Svc[Ensure Service]
        DB_Svc --> DB_Job{InitSQL?}
        DB_Job -- Yes --> Job[Create Schema Job]
        DB_Job -- No --> NextDB
    end
    
    Job --> NextDB[Next DB]
    NextDB --> Svcs[Reconcile Services]
    
    subgraph Svc_Reconcile [Service Reconciliation]
        Svcs --> Svc_Dep[Ensure Deployment]
        Svc_Dep --> Svc_Svc[Ensure Service]
    end
    
    Svc_Svc --> NextSvc[Next Service]
    NextSvc --> Prune[Prune Orphans]
    Prune --> Status[Update Status]
    Status --> Stop</div>
<hr />
<h2 id="test-framework-architecture">3. Test Framework Architecture</h2>
<p>We enable users to write procedural test scripts in
<strong>Lua</strong> that can manipulate the SUT and verify state. This
framework is designed to handle complex scenarios involving database
state, network interactions, and system versioning.</p>
<h3 id="reconciliation-logic-1">Reconciliation Logic</h3>
<div class="mermaid">flowchart TD
    Start([Reconcile Loop]) --> FetchCR{Fetch TestRun}
    FetchCR -- Not Found --> Stop([Stop])
    FetchCR -- Found --> CheckState{State?}
    
    CheckState -- Pending --> CreateCM[Create ConfigMap]
    CreateCM --> CreatePod[Create Runner Pod]
    CreatePod --> SetRunning[Set State: Running]
    SetRunning --> UpdateStatus
    
    CheckState -- Running --> CheckPod{Pod Phase?}
    CheckPod -- Succeeded --> SetPass[Set State: Passed]
    CheckPod -- Failed --> SetFail[Set State: Failed]
    CheckPod -- Running --> Requeue[Requeue]
    
    SetPass --> UpdateStatus[Update Status]
    SetFail --> UpdateStatus
    Requeue --> Stop
    UpdateStatus --> Stop</div>
<h3 id="components">Components</h3>
<ol type="1">
<li><strong>CLI (<code>kctrl</code>)</strong>:
<ul>
<li><code>kctrl test schedule --script test.lua --app my-app</code> —
Reads the script file, creates a <code>TestRun</code> CR.</li>
<li><code>kctrl test logs &lt;run-name&gt;</code> — Streams runner pod
logs in real-time.</li>
<li><code>kctrl test status &lt;run-name&gt;</code> — Shows State,
Result, Duration.</li>
</ul></li>
<li><strong><code>TestRun</code> CRD</strong>:
<ul>
<li>Represents a scheduled test execution.</li>
<li><strong>Spec</strong>:
<ul>
<li><code>appName</code>: Target App CR name (required).</li>
<li><code>script</code>: Inline Lua script content.</li>
<li><code>git</code>: Git source (URL, path, revision).</li>
<li><code>timeout</code>: Max execution time (enforced via
<code>activeDeadlineSeconds</code>).</li>
</ul></li>
<li><strong>Status</strong>: <code>Pending</code>, <code>Running</code>,
<code>Passed</code>, <code>Failed</code>, <code>Error</code>.</li>
</ul></li>
<li><strong>Test Controller</strong>:
<ul>
<li>Watches <code>TestRun</code> resources.</li>
<li>For inline scripts, creates a <strong>ConfigMap</strong> containing
the Lua script.</li>
<li>Spawns an ephemeral <strong>Test Runner Pod</strong> with the script
mounted as a volume.</li>
<li>Sets <code>activeDeadlineSeconds</code> on the pod from the
<code>timeout</code> field.</li>
<li>Monitors pod phase and updates TestRun status (via owner references
+ requeue).</li>
</ul></li>
<li><strong>Test Runner Pod</strong>:
<ul>
<li>Runtime environment with embedded <strong>Lua VM</strong>
(<code>gopher-lua</code>).</li>
<li>Pre-loaded <strong>Lua API</strong> bindings.</li>
<li>Receives <code>--app</code> and <code>--namespace</code> arguments
from the controller.</li>
</ul></li>
</ol>
<h3 id="lua-api-capabilities">Lua API Capabilities</h3>
<p>The framework exposes a rich API to control the environment:</p>
<h4 id="system-control-sut">1. System Control (SUT)</h4>
<p>Manipulate the system version and scale.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">sut</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;sut&quot;</span><span class="op">)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Update the &#39;frontend&#39; service to a specific version</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="va">sut</span><span class="op">.</span>apply_service<span class="op">(</span><span class="st">&quot;frontend&quot;</span><span class="op">,</span> <span class="op">{</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">image</span> <span class="op">=</span> <span class="st">&quot;my-org/web&quot;</span><span class="op">,</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;v1.2.0&quot;</span><span class="op">,</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">replicas</span> <span class="op">=</span> <span class="dv">3</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Wait for rollout to complete</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="va">sut</span><span class="op">.</span>wait_ready<span class="op">(</span><span class="st">&quot;frontend&quot;</span><span class="op">,</span> <span class="st">&quot;60s&quot;</span><span class="op">)</span></span></code></pre></div>
<h4 id="state-management-databasenetwork">2. State Management
(Database/Network)</h4>
<p>Seed databases and verify network connectivity.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">db</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;db&quot;</span><span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">http</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;http&quot;</span><span class="op">)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Database Seeding</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="va">db</span><span class="op">.</span>connect<span class="op">({</span> <span class="va">host</span><span class="op">=</span><span class="st">&quot;mock-app-db&quot;</span><span class="op">,</span> <span class="va">user</span><span class="op">=</span><span class="st">&quot;admin&quot;</span><span class="op">,</span> <span class="va">db</span><span class="op">=</span><span class="st">&quot;testdb&quot;</span> <span class="op">})</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="va">db</span><span class="op">.</span>seed<span class="op">({</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">table</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="op">,</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">rows</span><span class="op">={</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> <span class="va">name</span><span class="op">=</span><span class="st">&quot;alice&quot;</span><span class="op">,</span> <span class="va">role</span><span class="op">=</span><span class="st">&quot;admin&quot;</span> <span class="op">},</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> <span class="va">name</span><span class="op">=</span><span class="st">&quot;bob&quot;</span><span class="op">,</span> <span class="va">role</span><span class="op">=</span><span class="st">&quot;user&quot;</span> <span class="op">}</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Database Verification</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="va">db</span><span class="op">.</span>expect<span class="op">({</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">table</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="op">,</span> </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">where</span><span class="op">={</span> <span class="va">name</span><span class="op">=</span><span class="st">&quot;alice&quot;</span><span class="op">,</span> <span class="va">role</span><span class="op">=</span><span class="st">&quot;admin&quot;</span> <span class="op">}</span> </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Network Verification</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">resp</span> <span class="op">=</span> <span class="va">http</span><span class="op">.</span>get<span class="op">(</span><span class="st">&quot;http://frontend/api/users/alice&quot;</span><span class="op">)</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">assert</span><span class="op">(</span><span class="va">resp</span><span class="op">.</span><span class="va">code</span> <span class="op">==</span> <span class="dv">200</span><span class="op">,</span> <span class="st">&quot;User API reachable&quot;</span><span class="op">)</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">assert</span><span class="op">(</span><span class="va">resp</span><span class="op">.</span>json<span class="op">().</span><span class="va">role</span> <span class="op">==</span> <span class="st">&quot;admin&quot;</span><span class="op">,</span> <span class="st">&quot;User role correct&quot;</span><span class="op">)</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="op">####</span> <span class="dv">3.</span> <span class="va">gRPC</span> Services <span class="op">(</span><span class="va">Dynamic</span><span class="op">)</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="va">Invoke</span> <span class="va">gRPC</span> <span class="va">methods</span> <span class="va">dynamically</span> <span class="va">without</span> <span class="va">generating</span> <span class="va">Lua</span> stubs <span class="op">(</span><span class="va">requires</span> <span class="va">Server</span> <span class="va">Reflection</span><span class="op">).</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>```<span class="va">lua</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">grpc</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;grpc&quot;</span><span class="op">)</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- Call a gRPC method</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">res</span><span class="op">,</span> <span class="va">err</span> <span class="op">=</span> <span class="va">grpc</span><span class="op">.</span>call<span class="op">({</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="va">addr</span>    <span class="op">=</span> <span class="st">&quot;mock-app-echo:50051&quot;</span><span class="op">,</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="va">service</span> <span class="op">=</span> <span class="st">&quot;topas.EchoService&quot;</span><span class="op">,</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="va">method</span>  <span class="op">=</span> <span class="st">&quot;Echo&quot;</span><span class="op">,</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="va">body</span>    <span class="op">=</span> <span class="op">{</span> <span class="va">message</span> <span class="op">=</span> <span class="st">&quot;hello&quot;</span> <span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="fu">assert</span><span class="op">(</span><span class="va">res</span><span class="op">.</span><span class="va">message</span> <span class="op">==</span> <span class="st">&quot;hello&quot;</span><span class="op">,</span> <span class="st">&quot;gRPC response correct&quot;</span><span class="op">)</span></span></code></pre></div>
<h4 id="postman-collections">4. Postman Collections</h4>
<p>Execute existing Postman test suites from within Lua.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">pm</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;postman&quot;</span><span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">passed</span><span class="op">,</span> <span class="va">report</span> <span class="op">=</span> <span class="va">pm</span><span class="op">.</span>run<span class="op">({</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">collection</span>  <span class="op">=</span> <span class="st">&quot;tests/api-tests.json&quot;</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">environment</span> <span class="op">=</span> <span class="st">&quot;tests/staging.env.json&quot;</span><span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">folder</span>      <span class="op">=</span> <span class="st">&quot;Login Flow&quot;</span><span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="va">passed</span> <span class="cf">then</span> <span class="fu">error</span><span class="op">(</span><span class="st">&quot;Postman tests failed!&quot;</span><span class="op">)</span> <span class="cf">end</span></span></code></pre></div>
<hr />
<h2 id="workflows">4. Workflows</h2>
<h3 id="user-journey">User Journey</h3>
<ol type="1">
<li><strong>Deploy SUT</strong>: User applies <code>app.yaml</code> to
create the initial stack (services + databases).
<ul>
<li>SUT controller deploys Postgres, runs init Job with
<code>initSQL</code> schema.</li>
<li>SUT controller deploys app services with <code>DATABASE_URL</code>
env var.</li>
</ul></li>
<li><strong>Write Test</strong>: User writes
<code>upgrade_test.lua</code>.</li>
<li><strong>Run Test</strong>: User runs
<code>kctrl test schedule --script test.lua --app my-app</code>.
<ul>
<li>CLI creates <code>TestRun</code> CR.</li>
</ul></li>
<li><strong>Execution</strong>:
<ul>
<li>Controller creates Pod.</li>
<li>Pod runs Lua script.</li>
<li>Script interacts with <code>App</code> CR, Pods, and Database.</li>
</ul></li>
<li><strong>Result</strong>: CLI streams logs and reports
Pass/Fail.</li>
</ol>
<hr />
<h2 id="deployment-scaling-architecture">5. Deployment &amp; Scaling
Architecture</h2>
<p>TOPAS is designed to scale horizontally to handle thousands of
concurrent tests.</p>
<h3 id="control-plane">Control Plane</h3>
<ul>
<li><strong>TOPAS Controller</strong>: Deployed as a Kubernetes
Deployment (default 1 replica with leader election for HA).</li>
<li><strong>Responsibility</strong>:
<ul>
<li>Watches <code>TestRun</code> CRs.</li>
<li>Manages the “Queue” by reconciling <code>Pending</code> runs.</li>
<li>Enforces concurrency limits (e.g., max 50 concurrent tests).</li>
</ul></li>
</ul>
<h3 id="data-plane-execution">Data Plane (Execution)</h3>
<p>We support two execution models based on scale:</p>
<h4 id="standard-scale-current">1. Standard Scale (Current)</h4>
<ul>
<li><strong>Model</strong>: 1 Test = 1 Pod.</li>
<li><strong>Pros</strong>: Perfect isolation, simple lifecycle.</li>
<li><strong>Limit</strong>: ~50 concurrent tests/sec (Cluster
dependent).</li>
</ul>
<h4 id="high-scale-targeting-500-testssec">2. High Scale (Targeting 500+
tests/sec)</h4>
<p>To handle multi-tenant high throughput, we bypass Pod churn: *
<strong>Queue</strong>: <strong>Kafka</strong>, <strong>NATS
JetStream</strong>, or <strong>Redis Streams</strong> (External to API
Server). * <strong>Workers</strong>: Long-running <strong>Executor
Pods</strong> (e.g., 100 replicas). * <strong>Flow</strong>: 1. API
pushes test payload to Queue (e.g., Kafka topic
<code>tests.pending</code>). 2. Idle Executor pulls task. 3. Executor
creates isolated Lua VM context. 4. Runs script. 5. Reports result
async. * <strong>Isolation</strong>: Lua VM constraints (vs Docker
isolation).</p>
<h3 id="queueing-mechanism">Queueing Mechanism</h3>
<ol type="1">
<li><strong>Submission</strong>: User submits a test →
<code>TestRun</code> CR created (State: <code>Pending</code>).</li>
<li><strong>Queue</strong>: Kubernetes API Server acts as the persistent
queue.</li>
<li><strong>Scheduling</strong>: Controller picks up
<code>Pending</code> CRs. If
<code>ActiveTests &lt; MaxConcurrency</code>, creates a Runner Pod and
moves state to <code>Running</code>.</li>
</ol>
<hr />
<h2 id="git-integration-test-organization">6. Git Integration &amp; Test
Organization</h2>
<p>Tests are treated as code and organized in Git repositories.</p>
<h3 id="testrun-spec-update"><code>TestRun</code> Spec Update</h3>
<p>Support fetching scripts from Git:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> GitSource <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    URL      <span class="dt">string</span> <span class="st">`json:&quot;url&quot;`</span>      <span class="co">// e.g. https://github.com/org/tests.git</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    Path     <span class="dt">string</span> <span class="st">`json:&quot;path&quot;`</span>     <span class="co">// e.g. scenarios/upgrade.lua</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    Revision <span class="dt">string</span> <span class="st">`json:&quot;revision&quot;`</span> <span class="co">// e.g. main, v1.2, or commit-sha</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> TestRunSpec <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    AppName   <span class="dt">string</span>     <span class="st">`json:&quot;appName&quot;`</span>          <span class="co">// Target App CR name</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    Script    <span class="dt">string</span>     <span class="st">`json:&quot;script,omitempty&quot;`</span> <span class="co">// Inline script (optional)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    Git       <span class="op">*</span>GitSource <span class="st">`json:&quot;git,omitempty&quot;`</span>    <span class="co">// Git source</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    Timeout   <span class="dt">string</span>     <span class="st">`json:&quot;timeout,omitempty&quot;`</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="execution-flow">Execution Flow</h3>
<p><strong>Inline Script:</strong> 1.
<code>kctrl test schedule --script test.lua --app my-app</code> 2. CLI
reads file, creates <code>TestRun</code> CR with inline
<code>script</code> content. 3. Controller creates a
<strong>ConfigMap</strong> with the script, mounts it into the runner
pod. 4. Runner executes the script from the mounted volume.</p>
<p><strong>Git Source:</strong> 1.
<code>kctrl test schedule --git https://github.com/org/tests --git-path upgrade.lua --app my-app</code>
2. Runner starts with an <strong>Init Container</strong> that clones the
repo to a shared volume. 3. Main container executes the Lua script from
the cloned volume.</p>
<hr />
<h2 id="monitoring-observability">7. Monitoring &amp; Observability</h2>
<p>Users need visibility into the test queue and execution results.</p>
<h3 id="cli-tools">CLI Tools</h3>
<ul>
<li><code>kctrl test status</code>: Lists recent runs with state
(Pending, Running, Passed, Failed).</li>
<li><code>kctrl test logs &lt;id&gt;</code>: Streams logs from the
execution.</li>
</ul>
<h3 id="metrics-prometheus">Metrics (Prometheus)</h3>
<p>The Controller exposes standard metrics: -
<code>topas_queue_depth</code>: Number of pending tests. -
<code>topas_active_runners</code>: Number of currently running tests. -
<code>topas_test_duration_seconds</code>: Histogram of execution
time.</p>
<hr />
<h2 id="postman-integration-lua-driven">8. Postman Integration
(Lua-Driven)</h2>
<p>Postman collections are executed <strong>inside the runner
container</strong> as a subprocess, orchestrated by Lua.</p>
<h3 id="execution-model">Execution Model</h3>
<pre><code>Runner Pod (single container)
└── topas-runner
    ├── Go binary: /runner --script test.lua
    │   └── Lua VM
    │       ├── pm.run()   → exec newman (subprocess)
    │       ├── db.seed()  → direct SQL connection
    │       └── sut.wait() → K8s API
    └── newman CLI (pre-installed in image)</code></pre>
<h3 id="runner-image">Runner Image</h3>
<p>The <code>topas-runner</code> Docker image includes Node.js and
Newman alongside the Go runner binary.</p>
<h3 id="why-lua-drives">Why Lua Drives</h3>
<ul>
<li><strong>DB access</strong>: Lua’s <code>db</code> module
seeds/verifies data — Postman cannot connect to databases natively.</li>
<li><strong>K8s orchestration</strong>: Lua’s <code>sut</code> module
manages deployments before/after tests.</li>
<li><strong>Conditional logic</strong>: Run different collections based
on prior results.</li>
<li><strong>No CRD changes</strong>: <code>TestRun</code> stays simple;
Postman is just another Lua module.</li>
</ul>
<hr />
<h2 id="future-work">9. Future Work</h2>
<h3 id="web-dashboard">Web Dashboard</h3>
<ul>
<li>Visualize <code>TestRun</code> history.</li>
<li>Show real-time logs (WebSocket).</li>
<li>Pass/Fail rates and drill-down.</li>
</ul>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    </body>
    
</html>
